<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Google Drive ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†ç”Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    .container-layout {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }
    video {
      width: 100%;
      height: auto;
      min-height: 200px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
      background-color: #000;
      border-radius: 0.5rem;
      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å½±ã‚’æ®‹ã™ãŒã€è‰²ã‚’èª¿æ•´ */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    /* ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .spinner {
      border: 4px solid #f3f3f3; /* Light mode border */
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    /* Dark mode spinner adjustment */
    .dark .spinner {
        border-color: #374151; /* gray-700 equivalent */
        border-top-color: #60a5fa; /* blue-400 equivalent */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆãƒˆãƒªã‚­ãƒªç”»åƒï¼‰ */
    #title-screen {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    #title-screen.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
    @keyframes progress-animation {
      from { width: 0%; }
      to { width: 100%; }
    }
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #ts-progress-bar {
      height: 8px;
      background-color: #ffffff30; /* èƒŒæ™¯ã®è–„ã„ç™½ */
      border-radius: 4px;
      overflow: hidden;
    }
    #ts-progress-fill {
      height: 100%;
      background-color: #fff;
      width: 0%; /* åˆæœŸçŠ¶æ…‹ */
    }
    #title-screen.active #ts-progress-fill {
      /* 10ç§’ã‹ã‘ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      animation: progress-animation 10s linear forwards; 
    }
  </style>
</head>
<!-- Bodyã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯è‰²ã‚’è¨­å®š -->
<body class="p-4 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  <div class="container-layout"> 
    <header class="flex items-center justify-between text-center mb-6">
      <div class="w-10"></div> <!-- Left spacer -->
      <div class="flex-grow">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">ğŸ“½ï¸ Drive ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h1>
        <p class="text-gray-500 dark:text-gray-400">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é †åºã§å‹•ç”»ã‚’è‡ªå‹•å†ç”Ÿã—ã¾ã™</p>
      </div>
      <button id="help-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors w-10 h-10 flex items-center justify-center" title="æ“ä½œæ–¹æ³•ã‚’è¡¨ç¤º">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
    </header>

    <!-- å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ (bg-white -> dark:bg-gray-800) -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 relative">
      
      <!-- 10ç§’è¡¨ç¤ºç”¨ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆãƒˆãƒªã‚­ãƒªç”»åƒï¼‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³: è£ã§å‹•ç”»ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ä¸é€æ˜(bg-blue-700)ã«å¤‰æ›´ -->
      <div id="title-screen" class="absolute inset-0 bg-blue-700 text-white flex flex-col items-center justify-center p-8 rounded-xl z-10 transition-opacity duration-500">
        
        <!-- 1. ã‚¿ã‚¤ãƒˆãƒ«ã¨æ°åã®ä¸­å¤®ã‚¹ã‚¿ãƒƒã‚¯ã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="mb-12 text-center">
            <h2 id="ts-title" class="text-5xl sm:text-7xl font-extrabold mb-4">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</h2>
            <p class="text-2xl sm:text-3xl font-light">åˆ¶ä½œï¼š<span id="ts-creator" class="font-semibold">è£½ä½œè€…æ°å</span></p>
        </div>
        
        <!-- 2. ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ (ä¸‹ã«é…ç½®) -->
        <div id="ts-progress-bar-container" class="w-full max-w-md mb-8">
          <div id="ts-progress-bar" class="w-full">
            <div id="ts-progress-fill"></div>
          </div>
          <p class="text-xs sm:text-sm mt-2 text-center">å‹•ç”»å†ç”Ÿã¾ã§ 10 ç§’</p>
        </div>

        <!-- 3. ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
        <button id="skip-btn" class="px-6 py-2 bg-white/20 hover:bg-white/30 text-white rounded-full text-sm font-semibold transition backdrop-blur-sm border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
          ã™ãã«å†ç”Ÿ (Space)
        </button>

      </div>

      <video id="video-player" controls autoplay poster="https://placehold.co/800x450/e0e7ff/3b82f6?text=Loading+Playlist"></video>
      <div id="status-display" class="mt-4 text-center">
        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ–‡å­—è‰²ã‚’ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§æ˜ã‚‹ãã™ã‚‹ -->
        <div class="flex items-center justify-center space-x-2 text-gray-600 dark:text-gray-300">
          <div id="loading-spinner" class="spinner"></div>
          <p id="message-text" class="font-medium">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- åˆ¶å¾¡ãƒ»æƒ…å ±ãƒ‘ãƒãƒ« (bg-white -> dark:bg-gray-800) -->
    <div class="flex flex-col md:flex-row justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md gap-4">
      <!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã®è‰²èª¿æ•´ -->
      <div id="playlist-info" class="text-sm font-semibold text-gray-700 dark:text-gray-300 text-center md:text-left">
        ç¾åœ¨ã®å‹•ç”»: - / -
      </div>
      
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto justify-center items-center">
        <!-- å¹´åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <select id="year-filter" class="w-full sm:w-32 p-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
          <option value="">ã™ã¹ã¦ã®å¹´åº¦</option>
        </select>
        <!-- èª²é¡Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <select id="assignment-filter" class="w-full sm:w-48 p-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
          <option value="">ã™ã¹ã¦ã®èª²é¡Œ</option>
        </select>
      </div>

      <!-- Audio Output Selector -->
      <div id="audio-output-container" class="flex items-center w-full md:w-auto justify-center hidden">
        <select id="audio-output-selector" class="w-full md:w-64 p-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition-colors" title="éŸ³å£°ã®å‡ºåŠ›å…ˆã‚’é¸æŠ">
          <!-- Options populated by JS -->
        </select>
      </div>

      <div class="flex space-x-3">
        <!-- prev-btnã®è‰²èª¿æ•´ -->
        <button id="prev-btn" class="px-4 py-2 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 transition duration-150" disabled>
          å‰ã®å‹•ç”»
        </button>
        <!-- next-btnã¯é’ã‚’ç¶­æŒ -->
        <button id="next-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 transition duration-150" disabled>
          æ¬¡ã®å‹•ç”»
        </button>
      </div>
    </div>
    
    <!-- å†ç”Ÿäºˆå®šãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¸€è¦§ (bg-white -> dark:bg-gray-800) -->
    <div id="playlist-list-container" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mt-4">
        <!-- è¦‹å‡ºã—ã®è‰²èª¿æ•´ -->
        <h3 class="text-xl font-bold text-gray-800 dark:text-white border-b pb-2 mb-3">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h3>
        <ul id="playlist-ul" class="space-y-2">
            <!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²èª¿æ•´ -->
            <li class="text-gray-500 dark:text-gray-400 italic">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</li>
        </ul>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <!-- Overlay -->
    <div id="modal-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    
    <!-- Modal Content -->
    <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-600">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">æ“ä½œæ–¹æ³•ã¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h2>
        <button id="close-modal-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <ul class="space-y-3 text-gray-700 dark:text-gray-300">
        <li class="flex items-center justify-between">
          <span>å†ç”Ÿ / ä¸€æ™‚åœæ­¢</span>
          <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Space</kbd>
        </li>
        <li class="flex items-center justify-between">
          <span>ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’ã‚¹ã‚­ãƒƒãƒ—</span>
          <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Space</kbd>
        </li>
        <li class="flex items-center justify-between">
          <span>æ¬¡ã®å‹•ç”» / å‰ã®å‹•ç”»</span>
          <div class="flex gap-1">
            <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">â†</kbd>
            <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">â†’</kbd>
          </div>
        </li>
        <li class="flex items-center justify-between">
          <span>ãƒªã‚¹ãƒˆé¸æŠ / å†ç”Ÿ</span>
          <div class="flex gap-1">
            <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">â†‘</kbd>
            <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">â†“</kbd>
            <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Enter</kbd>
          </div>
        </li>
         <li class="flex items-center justify-between">
          <span>ã“ã®ç”»é¢ã‚’é–‰ã˜ã‚‹</span>
          <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Esc</kbd>
        </li>
      </ul>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const videoPlayer = document.getElementById('video-player');
      const messageText = document.getElementById('message-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      const playlistInfo = document.getElementById('playlist-info');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const skipBtn = document.getElementById('skip-btn');
      const assignmentFilter = document.getElementById('assignment-filter');
      const yearFilter = document.getElementById('year-filter');

      // Audio Output elements
      const audioOutputContainer = document.getElementById('audio-output-container');
      const audioOutputSelector = document.getElementById('audio-output-selector');

      // Help Modal elements
      const helpBtn = document.getElementById('help-btn');
      const helpModal = document.getElementById('help-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const modalOverlay = document.getElementById('modal-overlay');
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¦ç´ 
      const titleScreen = document.getElementById('title-screen');
      const tsTitle = document.getElementById('ts-title');
      const tsCreator = document.getElementById('ts-creator');
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¦ç´ 
      const tsProgressFill = document.getElementById('ts-progress-fill');
      
      // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¸€è¦§è¦ç´ 
      const playlistUl = document.getElementById('playlist-ul'); 
      
      // å®šæ•°
      const TITLE_SCREEN_DURATION_MS = 10000; // 10ç§’
      const MAX_RETRIES = 1; // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’æ¸›ã‚‰ã™

      let fullPlaylist = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰ã®å…¨ãƒªã‚¹ãƒˆ
      let playlist = [];
      let currentVideoIndex = -1;
      let countdownTimeout = null; // setTimeoutã§ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å®Œäº†æ™‚ã®å‡¦ç†ã‚’ç®¡ç†
      let selectedListItemIndex = -1; // é¸æŠã•ã‚ŒãŸãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (å†ç”Ÿå¾…ã¡ãƒªã‚¹ãƒˆå†…)
      
      /**
       * Google Driveã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‹ã‚‰ç›´æ¥å†ç”Ÿå¯èƒ½ãªURLã‚’ä½œæˆã—ã¾ã™ã€‚
       * @param {string} fileId Google Driveã®ãƒ•ã‚¡ã‚¤ãƒ«ID
       * @returns {string} å‹•ç”»ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°URL
       */
      function createVideoUrl(fileId) {
        return `https://drive.google.com/uc?id=${fileId}&export=download`;
      }

      /**
       * ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’è¡¨ç¤ºã—ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
       * @param {string} title å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«
       * @param {string} creator è£½ä½œè€…æ°å
       * @param {string} fileId å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ID (ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ç”¨)
       */
      function showTitleScreen(title, creator, fileId) {
        tsTitle.textContent = title;
        tsCreator.textContent = creator;
        titleScreen.classList.add('active');
        
        // è£ã§å‹•ç”»ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
        // ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒä¸é€æ˜ãªã®ã§ã€è£ã§ãƒ­ãƒ¼ãƒ‰ä¸­ã®ç”»é¢ã«ãªã£ã¦ã‚‚å•é¡Œãªã„
        const videoUrl = createVideoUrl(fileId);
        videoPlayer.src = videoUrl;
        videoPlayer.load();

        startProgressBar(playlist[currentVideoIndex]);
      }
      
      /**
       * ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã€‚
       */
      function hideTitleScreen() {
        titleScreen.classList.remove('active');
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        tsProgressFill.style.animation = 'none';
        tsProgressFill.offsetHeight; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        tsProgressFill.style.animation = null;
        
        // videoPlayer.poster = ''; // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ã®ã§ãƒã‚¹ã‚¿ãƒ¼æ“ä½œã¯ä¸è¦
      }

      /**
       * ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å³åº§ã«å†ç”Ÿã—ã¾ã™ã€‚
       */
      function skipTitleScreen() {
        if (countdownTimeout) {
          clearTimeout(countdownTimeout);
          startActualVideo(playlist[currentVideoIndex]);
        }
      }

      /**
       * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€å®Œäº†æ™‚ã®å‡¦ç†ã‚’è¨­å®šã—ã¾ã™ã€‚
       * @param {object} item ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ 
       */
      function startProgressBar(item) {
        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (countdownTimeout) {
          clearTimeout(countdownTimeout);
        }
        
        // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹ã™ã‚‹ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
        titleScreen.classList.remove('active');
        // ç¬é–“çš„ãªDOMæ“ä½œã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        tsProgressFill.style.animation = 'none';
        void tsProgressFill.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶
        
        // å†åº¦activeã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
        titleScreen.classList.add('active');
        
        // 10ç§’å¾Œã«å‹•ç”»å†ç”Ÿã‚’é–‹å§‹ã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
        countdownTimeout = setTimeout(() => {
          startActualVideo(item);
        }, TITLE_SCREEN_DURATION_MS);
      }

      /**
       * å®Ÿéš›ã®å‹•ç”»å†ç”Ÿã‚’é–‹å§‹ã—ã¾ã™ã€‚
       * @param {object} item ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ 
       */
      function startActualVideo(item) {
        hideTitleScreen();

        // srcã¯showTitleScreenã§æ—¢ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ã‚»ãƒƒãƒˆã—ãªã„
        updateStatus(`å†ç”Ÿæº–å‚™å®Œäº†... (${currentVideoIndex + 1} / ${playlist.length})`, true);

        const playPromise = videoPlayer.play();

        if (playPromise !== undefined) {
          playPromise.catch(error => {
            // è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®å‡¦ç†
            updateStatus('å‹•ç”»ã®è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', false, 'text-red-600');
          });
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®è‰²ã®èª¿æ•´ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¦–èªã—ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
        updateStatus(`å‹•ç”»å†ç”Ÿä¸­: ${item.title}`, false, 'text-blue-500 dark:text-blue-400');
        updateControls();
      }


      /**
       * å‹•ç”»ã®å†ç”Ÿã‚’è©¦ã¿ã¾ã™ã€‚ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã‹ã‚‰é–‹å§‹ï¼‰
       * @param {number} index å†ç”Ÿã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
       */
      function playVideo(index) {
        // é€²è¡Œã™ã‚‹å‰ã«æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (countdownTimeout) {
          clearTimeout(countdownTimeout);
        }

        if (index < 0 || index >= playlist.length) {
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®è‰²ã®èª¿æ•´ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¦–èªã—ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
          updateStatus('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æœ€åˆã¾ãŸã¯æœ€å¾Œã«åˆ°é”ã—ã¾ã—ãŸã€‚', false, 'text-yellow-600 dark:text-yellow-400');
          currentVideoIndex = Math.max(0, Math.min(index, playlist.length - 1));
          updateControls();
          updatePlaylistInfo(); // ãƒªã‚¹ãƒˆã®æœ€çµ‚çŠ¶æ…‹ã‚’åæ˜ 
          return;
        }

        currentVideoIndex = index;
        selectedListItemIndex = -1; // å‹•ç”»å†ç”Ÿã‚’é–‹å§‹ã—ãŸã‚‰é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

        const item = playlist[currentVideoIndex];
        
        // å‹•ç”»ã®å†ç”Ÿå‰ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’è¡¨ç¤ºã—ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’é–‹å§‹
        updateStatus(`ãƒˆãƒªã‚­ãƒªç”»åƒã‚’è¡¨ç¤ºä¸­... (${currentVideoIndex + 1} / ${playlist.length})`, true);
        showTitleScreen(item.title, item.creator, item.fileId);

        updatePlaylistInfo(); // å†ç”Ÿæƒ…å ±ã¨ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        updateControls();
      }

      /**
       * æ¬¡ã®å‹•ç”»ã‚’å†ç”Ÿã—ã¾ã™ã€‚
       */
      function playNextVideo() {
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’åœæ­¢
        if (countdownTimeout) { clearTimeout(countdownTimeout); }

        if (currentVideoIndex < playlist.length - 1) {
          playVideo(currentVideoIndex + 1);
        } else {
          hideTitleScreen();
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®è‰²ã®èª¿æ•´ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¦–èªã—ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
          updateStatus('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æœ€å¾Œã¾ã§å†ç”Ÿã—ã¾ã—ãŸã€‚', false, 'text-green-600 dark:text-green-400');
          currentVideoIndex = playlist.length; // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æœ€å¾Œã¾ã§åˆ°é”ã—ãŸã“ã¨ã‚’ç¤ºã™
          updatePlaylistInfo(); // æœ€çµ‚ãƒªã‚¹ãƒˆçŠ¶æ…‹ã‚’åæ˜ 
        }
      }

      /**
       * å‰ã®å‹•ç”»ã‚’å†ç”Ÿã—ã¾ã™ã€‚
       */
      function playPrevVideo() {
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’åœæ­¢
        if (countdownTimeout) { clearTimeout(countdownTimeout); }

        if (currentVideoIndex > 0) {
          playVideo(currentVideoIndex - 1);
        }
      }

      /**
       * ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¸€è¦§ï¼ˆç¾åœ¨ã®å‹•ç”»ä»¥é™ï¼‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
       */
      function renderPlaylistList() {
          playlistUl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

          // å…¨ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
          const totalLength = playlist.length;
          const listItems = []; 
          
          if (totalLength === 0) {
              // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®ãƒ†ã‚­ã‚¹ãƒˆè‰²
              playlistUl.innerHTML = '<li class="text-gray-500 dark:text-gray-400 italic py-2">å†ç”Ÿäºˆå®šã®å‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
              selectedListItemIndex = -1;
              return;
          }

          // é¸æŠã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç¯„å›²å¤–ã®å ´åˆã¯èª¿æ•´
          if (selectedListItemIndex >= totalLength) {
             selectedListItemIndex = totalLength - 1;
          }
          // ãƒªã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã€é¸æŠçŠ¶æ…‹ãŒ-1ã§ã‚ã‚Œã°ã€å…ˆé ­ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
          // if (selectedListItemIndex < 0) {
          //    selectedListItemIndex = 0; 
          // }
          
          playlist.forEach((item, index) => {
              const li = document.createElement('li');
              
              let liClass = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 hover:bg-gray-100 dark:bg-gray-700/50 dark:hover:bg-gray-700 transition duration-150 cursor-pointer';
              let titleColor = 'text-gray-700 dark:text-gray-200';
              let creatorColor = 'text-gray-500 dark:text-gray-400';
              let badgeClass = 'bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300';

              // å†ç”Ÿä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ 
              if (index === currentVideoIndex) {
                  liClass = 'flex justify-between items-center p-2 rounded-lg bg-blue-100 dark:bg-blue-900/80 border-l-4 border-blue-500 transition duration-150 cursor-pointer';
                  titleColor = 'text-blue-800 dark:text-blue-100 font-bold';
                  creatorColor = 'text-blue-600 dark:text-blue-300';
                  badgeClass = 'bg-blue-500 text-white';
              }
              // å†ç”Ÿæ¸ˆã¿ã®ã‚¢ã‚¤ãƒ†ãƒ 
              else if (index < currentVideoIndex) {
                  liClass = 'flex justify-between items-center p-2 rounded-lg bg-gray-100 dark:bg-gray-800/50 opacity-60 hover:opacity-100 transition duration-150 cursor-pointer';
              }

              // ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
              if (index === selectedListItemIndex) {
                  // é¸æŠæ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ã‚¤ãƒ« (é’ã„èƒŒæ™¯ã€å¤ªã„æ ç·šã€ãƒ†ã‚­ã‚¹ãƒˆå¼·èª¿)
                  liClass += ' ring-2 ring-blue-400 dark:ring-blue-500';
              }
              
              li.className = liClass;
              
              li.dataset.index = index;
              
              // ã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
              li.addEventListener('click', () => {
                  selectedListItemIndex = index;
                  playVideo(index);
              });
              
              li.innerHTML = `
                  <div class="flex-grow min-w-0">
                      ${item.assignment ? `<span class="text-xs text-gray-500 dark:text-gray-400 block mb-0.5">${item.assignment}</span>` : ''}
                      ${item.year ? `<span class="text-xs text-gray-400 dark:text-gray-500 inline-block mr-2">[${item.year}]</span>` : ''}
                      <span class="font-bold ${titleColor} truncate block">${item.title}</span>
                      <span class="text-xs ${creatorColor} block">åˆ¶ä½œ: ${item.creator}</span>
                  </div>
                  <span class="ml-4 text-sm px-2 py-1 font-bold rounded-full ${badgeClass}">${index + 1}</span>
              `;
              
              listItems.push(li);
          });
          
          playlistUl.append(...listItems);
          
          // é¸æŠã•ã‚ŒãŸè¦ç´ ãŒè¡¨ç¤ºé ˜åŸŸå†…ã«ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
          if (selectedListItemIndex >= 0) {
            // data-indexã‚’ä½¿ç”¨ã—ã¦æ­£ç¢ºãªè¦ç´ ã‚’å–å¾—
            const selectedElement = playlistUl.querySelector(`[data-index="${selectedListItemIndex}"]`);
            if (selectedElement) {
              selectedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }
      }

      /**
       * Sets up the audio output device selector if supported by the browser.
       */
      async function setupAudioOutputSelector() {
        if (!('setSinkId' in HTMLMediaElement.prototype)) {
          console.log('Audio output device selection is not supported by this browser.');
          return;
        }

        try {
          // We need to get user permission to enumerate devices with labels.
          // A silent audio stream is enough.
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
          // Stop the track immediately once we have permission.
          stream.getTracks().forEach(track => track.stop());

          await populateAudioDevices();
          audioOutputContainer.classList.remove('hidden');

          // Add event listener
          audioOutputSelector.addEventListener('change', changeAudioOutput);

        } catch (err) {
          console.error('Error setting up audio output selector:', err);
          // Don't show the selector if we can't get permissions or devices.
        }
      }

      async function populateAudioDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioOutputs = devices.filter(device => device.kind === 'audiooutput');

        audioOutputSelector.innerHTML = ''; // Clear existing options

        if (audioOutputs.length === 0) {
          audioOutputContainer.classList.add('hidden');
          return;
        }

        const savedDeviceId = localStorage.getItem('audioOutputDeviceId');

        audioOutputs.forEach(device => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.textContent = device.label || `Speaker ${audioOutputSelector.options.length + 1}`;
          if (device.deviceId === savedDeviceId) {
            option.selected = true;
          }
          audioOutputSelector.appendChild(option);
        });

        // Apply the saved (or default) device
        await changeAudioOutput();
      }

      async function changeAudioOutput() {
        const deviceId = audioOutputSelector.value;
        if (!deviceId) return;

        try {
          await videoPlayer.setSinkId(deviceId);
          console.log(`Audio output successfully changed to: ${audioOutputSelector.options[audioOutputSelector.selectedIndex].text}`);
          localStorage.setItem('audioOutputDeviceId', deviceId);
        } catch (err) {
          console.error('Failed to set audio output device:', err);
        }
      }

      /**
       * ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±ã¨ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã™ã€‚
       */
      function updatePlaylistInfo() {
        if (playlist.length > 0 && currentVideoIndex < playlist.length) {
          const title = playlist[currentVideoIndex] ? playlist[currentVideoIndex].title : 'å†ç”Ÿå®Œäº†';
          playlistInfo.textContent = `ç¾åœ¨ã®å‹•ç”»: ${currentVideoIndex + 1} / ${playlist.length} (${title})`;
        } else if (currentVideoIndex === playlist.length) {
          playlistInfo.textContent = `ç¾åœ¨ã®å‹•ç”»: ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†ç”Ÿå®Œäº†`;
        } else {
          playlistInfo.textContent = `ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç©ºã§ã™`;
        }
        
        // å†ç”Ÿãƒªã‚¹ãƒˆã®æ›´æ–°
        renderPlaylistList();
      }
      
      /**
       * ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚
       */
      function updateControls() {
        const hasPlaylist = playlist.length > 0;
        prevBtn.disabled = !hasPlaylist || currentVideoIndex <= 0;
        nextBtn.disabled = !hasPlaylist || currentVideoIndex >= playlist.length - 1;
      }

      /**
       * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
       * @param {string} message è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
       * @param {boolean} isLoading ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹
       * @param {string} colorClass ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²ã‚¯ãƒ©ã‚¹ (Tailwind)
       */
      function updateStatus(message, isLoading, colorClass = 'text-gray-600 dark:text-gray-300') {
        messageText.textContent = message;
        messageText.className = `font-medium ${colorClass}`;
        loadingSpinner.style.display = isLoading ? 'block' : 'none';
        
        // ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºä¸­ã¯ãƒã‚¹ã‚¿ãƒ¼ç”»åƒã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒæ‹…å½“ã™ã‚‹ãŸã‚ç©ºã«ã—ã¾ã™
        if (!titleScreen.classList.contains('active')) {
            videoPlayer.poster = isLoading ? 'https://placehold.co/800x450/e0e7ff/3b82f6?text=Loading...' : '';
        }
      }

      /**
       * Opens the help modal.
       */
      function openHelpModal() {
        helpModal.classList.remove('hidden');
      }

      /**
       * Closes the help modal.
       */
      function closeHelpModal() {
        helpModal.classList.add('hidden');
      }

      /**
       * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰GASã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
       */
      async function fetchPlaylist() {
        updateStatus('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...', true);
        
        // GitHub Pagesãªã©ã§ãƒ›ã‚¹ãƒˆã™ã‚‹å ´åˆã€GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’ç›´æ¥æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        // GASã®ãƒ‡ãƒ—ãƒ­ã‚¤ç”»é¢ã§ç™ºè¡Œã•ã‚ŒãŸã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã€ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
        // â€»å¿…ãšã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã€>ã€Œæ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã§ç™ºè¡Œã—ãŸæœ€æ–°ã®URLã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwbPR7ewBa6iikUUEzPl3Pm3SPgIVT2ItAME9poEJE5hTBC24X91PDBTuEryf4pFGPZ/exec"; 
        const url = `${GAS_API_URL}?action=getPlaylist`;

        for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
            try {
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š (15ç§’)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const response = await fetch(url, { signal: controller.signal }).catch(err => {
                    throw new Error(err.name === 'AbortError' ? 'æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚' : err.message);
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚HTMLãŒè¿”ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:", text.substring(0, 500));
                    throw new Error("ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆã‚¢ã‚¯ã‚»ã‚¹æ¨©é™: å…¨å“¡ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }

                if (data.error) {
                    throw new Error(data.details || data.error);
                }

                fullPlaylist = data.playlist || [];
                if (fullPlaylist.length === 0) {
                    updateStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å‹•ç”»IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', false, 'text-red-500 dark:text-red-400');
                    updatePlaylistInfo(); // ç©ºãƒªã‚¹ãƒˆã‚’åæ˜ 
                    return;
                }

                updateStatus(`ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ (${fullPlaylist.length} ä»¶) ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚`, false, 'text-blue-500 dark:text-blue-400');
                populateFilters();
                filterPlaylist(); // åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã™ã¹ã¦ï¼‰ã¨å†ç”Ÿé–‹å§‹
                return;

            } catch (error) {
                console.error('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                if (attempt === MAX_RETRIES - 1) {
                    updateStatus(`ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${error.message}`, false, 'text-red-700 dark:text-red-400');
                } else {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      videoPlayer.addEventListener('ended', playNextVideo);
      videoPlayer.addEventListener('error', (e) => {
        console.error('Video Playback Error:', e);
        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å•é¡Œãªã©ã§å†ç”Ÿã«å¤±æ•—ã—ãŸå ´åˆã€æ¬¡ã®å‹•ç”»ã¸ã‚¹ã‚­ãƒƒãƒ—
        updateStatus(`ç¾åœ¨ã®å‹•ç”»ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¬¡ã®å‹•ç”»ã¸ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`, false, 'text-orange-500 dark:text-orange-400');
        playNextVideo(); 
      });

      prevBtn.addEventListener('click', playPrevVideo);
      nextBtn.addEventListener('click', playNextVideo);
      skipBtn.addEventListener('click', skipTitleScreen);
      assignmentFilter.addEventListener('change', filterPlaylist);
      yearFilter.addEventListener('change', filterPlaylist);
      // Help Modal Listeners
      helpBtn.addEventListener('click', openHelpModal);
      closeModalBtn.addEventListener('click', closeHelpModal);
      modalOverlay.addEventListener('click', closeHelpModal);
      
      // --- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è¿½åŠ  ---
      document.addEventListener('keydown', (event) => {
          // If modal is open, only listen for Escape key
          if (!helpModal.classList.contains('hidden')) {
              if (event.key === 'Escape') {
                  closeHelpModal();
              }
              return; // Do nothing else
          }

          // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç„¡è¦–
          if (playlist.length === 0) return;
          
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå…¥åŠ›è¦ç´ ã«ã‚ã‚‹å ´åˆã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ç„¡åŠ¹ã«ã™ã‚‹
          if (event.target.tagName === 'INPUT' || 
              event.target.tagName === 'TEXTAREA' || 
              event.target.isContentEditable) {
              return;
          }

          const totalLength = playlist.length;

          switch (event.key) {
              case 'ArrowLeft': // å·¦çŸ¢å°ã‚­ãƒ¼: å‰ã®å‹•ç”»
                  event.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ã‚’é˜²æ­¢
                  if (!prevBtn.disabled) {
                      playPrevVideo();
                  }
                  break;
              case 'ArrowRight': // å³çŸ¢å°ã‚­ãƒ¼: æ¬¡ã®å‹•ç”»
                  event.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ã‚’é˜²æ­¢
                  if (!nextBtn.disabled) {
                      playNextVideo();
                  }
                  break;
              case ' ': // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼: å†ç”Ÿ/ä¸€æ™‚åœæ­¢
                  // ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã€ã‹ã¤ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã®ã¿
                  if (!titleScreen.classList.contains('active') && currentVideoIndex < playlist.length) {
                      event.preventDefault();
                      if (videoPlayer.paused) {
                          // å†ç”Ÿé–‹å§‹
                          videoPlayer.play().catch(error => {
                              console.warn("Play failed (space key):", error);
                          });
                          updateStatus(`å‹•ç”»å†ç”Ÿä¸­: ${playlist[currentVideoIndex].title}`, false, 'text-blue-500 dark:text-blue-400');
                      } else {
                          // ä¸€æ™‚åœæ­¢
                          videoPlayer.pause();
                          updateStatus(`å‹•ç”»ä¸€æ™‚åœæ­¢ä¸­: ${playlist[currentVideoIndex].title}`, false, 'text-yellow-600 dark:text-yellow-400');
                      }
                  } else if (titleScreen.classList.contains('active')) {
                      // ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—
                      event.preventDefault();
                      skipTitleScreen();
                  }
                  break;
              
              // --- æ–°ã—ã„ã‚­ãƒ¼æ“ä½œ: ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---
              case 'ArrowUp':
              case 'ArrowDown':
                  event.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢

                  if (totalLength <= 0) {
                    // å†ç”Ÿå¾…ã¡ãƒªã‚¹ãƒˆãŒãªã„å ´åˆ
                    selectedListItemIndex = -1;
                    return;
                  }
                  
                  // åˆæœŸé¸æŠã¾ãŸã¯ç¯„å›²å¤–ã®å ´åˆã¯èª¿æ•´
                  if (selectedListItemIndex === -1) {
                      selectedListItemIndex = currentVideoIndex; // ç¾åœ¨ã®å‹•ç”»ã‹ã‚‰é–‹å§‹
                  } else if (event.key === 'ArrowUp') {
                      // ä¸Šã«ç§»å‹•
                      selectedListItemIndex = Math.max(0, selectedListItemIndex - 1);
                  } else if (event.key === 'ArrowDown') {
                      // ä¸‹ã«ç§»å‹•
                      selectedListItemIndex = Math.min(totalLength - 1, selectedListItemIndex + 1);
                  }
                  
                  // é¸æŠçŠ¶æ…‹ã‚’åæ˜ ã—ã¦ãƒªã‚¹ãƒˆã‚’å†æç”»
                  renderPlaylistList();
                  break;

              case 'Enter': // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼: é¸æŠã—ãŸå‹•ç”»ã‚’å†ç”Ÿ
                  if (selectedListItemIndex >= 0 && totalLength > 0) {
                      event.preventDefault();
                      // é¸æŠã—ãŸå‹•ç”»ã®å†ç”Ÿã‚’é–‹å§‹
                      playVideo(selectedListItemIndex);
                      // playVideoå†…ã§selectedListItemIndexã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™
                  } else if (currentVideoIndex >= 0 && currentVideoIndex < playlist.length) {
                    // é¸æŠãŒãªã„å ´åˆã€ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã¨åŒã˜å‹•ä½œï¼ˆå†ç”Ÿ/ä¸€æ™‚åœæ­¢ï¼‰ã‚’è¡Œã†
                    if (!titleScreen.classList.contains('active')) {
                         event.preventDefault();
                         if (videoPlayer.paused) {
                              videoPlayer.play().catch(error => {
                                  console.warn("Play failed (enter key):", error);
                              });
                              updateStatus(`å‹•ç”»å†ç”Ÿä¸­: ${playlist[currentVideoIndex].title}`, false, 'text-blue-500 dark:text-blue-400');
                          } else {
                              videoPlayer.pause();
                              updateStatus(`å‹•ç”»ä¸€æ™‚åœæ­¢ä¸­: ${playlist[currentVideoIndex].title}`, false, 'text-yellow-600 dark:text-yellow-400');
                          }
                    }
                  }
                  break;
          }
      });
      // --- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è¿½åŠ  çµ‚äº† ---

      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      fetchPlaylist();
      setupAudioOutputSelector();
    });
  </script>
</body>
</html>